<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>

  <button onclick="answer();">Confirm</button>
  <script type="text/javascript">
    const { offer, iceCandidates } = JSON.parse(decodeURIComponent(escape(atob(window.location.hash.substring(1)))));

    async function prepareAnswer(offer, iceCandidates) {
      let peerConnection = new RTCPeerConnection({ iceServers: [] });
      const localIceCandidates = [];
      peerConnection.ondatachannel = (event) => {
        event.channel.onmessage = (event) => {
          const pTag = document.createElement('p');
          pTag.textContent = event.data;
          document.body.appendChild(pTag);
        };
      };
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          localIceCandidates.push(event.candidate);
        }
      };
      await peerConnection.setRemoteDescription(offer);
      iceCandidates.forEach((serializedCandidate) => peerConnection.addIceCandidate(
        new RTCIceCandidate(serializedCandidate),
      ),);
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);

      await wait();
      return {
        answer,
        iceCandidates: localIceCandidates,
      };
    }

    async function serializeAnswer({ answer, iceCandidates = [] } = {}) {
      return JSON.stringify({ answer, iceCandidates });
    }

    function contactDesktop(serializedAnswer) {
      const desktopDeeplink = `wtc://what-to-click.com/answer#${encodeURIComponent(btoa(serializedAnswer))}`;
      console.debug('deeplink:', { desktopDeeplink });
      window.open(desktopDeeplink, '_blank');
    }

    const wait = (ms = 1000) => new Promise((resolve, _) => setTimeout(resolve, ms));

    window.answer = () => prepareAnswer(offer, iceCandidates).then(serializeAnswer).then(contactDesktop);

  </script>
</body>

</html>