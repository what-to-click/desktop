<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    img {
      display: inline-block;
      max-height: 200px;
    }
  </style>
</head>

<body>

  <button onclick="answer();">Confirm</button>
  <script type="text/javascript">
    const { offer, iceCandidates } = JSON.parse(decodeURIComponent(escape(atob(window.location.hash.substring(1)))));
    const receivedMessages = [];
    window.receivedMessages = receivedMessages;

    async function prepareAnswer(offer, iceCandidates) {
      let peerConnection = new RTCPeerConnection({ iceServers: [] });
      const localIceCandidates = [];
      peerConnection.ondatachannel = (event) => {
        event.channel.onmessage = (event) => {
          document.body.style.cursor = 'wait';
          const data = JSON.parse(event.data);
          receivedMessages.push(data);
          if (data.type === 'end') {
            loadSession();
            document.body.style.cursor = 'pointer';
          }
        };
      };
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          localIceCandidates.push(event.candidate);
        }
      };
      await peerConnection.setRemoteDescription(offer);
      iceCandidates.forEach((serializedCandidate) => peerConnection.addIceCandidate(
        new RTCIceCandidate(serializedCandidate),
      ),);
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);

      await wait();
      return {
        answer,
        iceCandidates: localIceCandidates,
      };
    }

    async function serializeAnswer({ answer, iceCandidates = [] } = {}) {
      return JSON.stringify({ answer, iceCandidates });
    }

    function contactDesktop(serializedAnswer) {
      const desktopDeeplink = `wtc://what-to-click.com/answer#${encodeURIComponent(btoa(serializedAnswer))}`;
      const win = window.open(desktopDeeplink, '_blank');
      if (win) {
        win.close();
      }
    }

    function loadSession(messages = receivedMessages.filter(({ type }) => type === 'data')) {
      const clicks = {};
      for (const message of messages) {
        if (!clicks[message._id]) {
          clicks[message._id] = { screenshot: 'data:image/png;base64,' };
        }

        clicks[message._id] = {
          ...message,
          screenshot: clicks[message._id].screenshot + message.screenshot,
        }
      }

      for (const message of Object.values(clicks)) {
        const imageNode = document.createElement('img');
        imageNode.src = message.screenshot;
        document.body.appendChild(imageNode);
      }
    }

    const wait = (ms = 1000) => new Promise((resolve, _) => setTimeout(resolve, ms));

    window.answer = () => prepareAnswer(offer, iceCandidates).then(serializeAnswer).then(contactDesktop);

  </script>
</body>

</html>